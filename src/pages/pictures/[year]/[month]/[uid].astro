---
// assets
import '@styles/tokens/color.css';
import '@styles/tokens/type.css';
import '@styles/utilities/borders.css';
import '@styles/utilities/type.css';

// utilities
import { format } from 'date-fns';
import { picture as permalink } from '@lib/routes';
import { arrayToSentence, removeWidows } from '@lib/stringHelpers';
import * as prismicHelpers from '@prismicio/helpers';
import prismic from '@lib/prismic';

// components
import BlockList from '@components/BlockList.astro';
import Figure from '@components/blocks/Figure.astro';
import Gallery from '@components/layout/Gallery.astro';
import Heading from '@components/blocks/Heading.astro';
import Image from '@components/elements/Image.astro';
import Layout from '@layouts/BaseLayout.astro';

export async function getStaticPaths() {
 	const pictures = await prismic.getAllByType('picture', {
		orderings: {
			field: 'my.picture.date_completed',
			direction: 'desc',
		},
		graphQuery: `
			{
				picture {
					...pictureFields
					series {
						...on picture_series {
							...picture_seriesFields
						}
					}
					media {
						medium {
							...on picture_medium {
								...picture_mediumFields
							}
						}
					}
					substrate {
						...on picture_substrate {
							name
						}
					}
					editions {
						...editionsFields
						size {
							...on print_size {
								...print_sizeFields
							}
						}
					}
				}
			}
		`,
	});

	//console.log(pictures[0].data);

 	return pictures.map(({ uid, data }, index) => {
		const date = prismicHelpers.asDate(data.date_completed);
		const nextPicture = pictures[index + 1];

 		return {
 			params: {
 				year: format(date, 'yyyy'),
 				month: format(date, 'MM'),
 				uid,
 			},
 			props: {
 				...data,
 				next: nextPicture && {
					title: nextPicture.data.title,
					subtitle: nextPicture.data.subtitle,
					path: permalink(nextPicture),
				},
 			},
 		};
 	});
}

const {
	title,
	orientation,
	width,
	height,
	substrate,
	media,
	date_completed,
	series,
	editions,
	cover,
	body,
} = Astro.props;

const date = prismicHelpers.asDate(date_completed);

function createMediaString() {
	// convert the list of media to a sentence
	let string = arrayToSentence(
		media.map(({ medium }) => (medium.data.name)),
		{ period: false }
	);

	// add the substrate as a suffix
	if (prismicHelpers.isFilled.link(substrate)) {
		string += ` on ${substrate.data.name.toLowerCase()}`;
	}

	if (width && height) {
		string += `&nbsp;&bull;&nbsp;${width} x ${height}`;
	}

	return string;
}
---

<Layout path="pictures">
	<header>
		<Figure source={cover} fit="cover" />
		<div class="info">
			<Heading level={1} text={title} />
			<time datetime={date.toString()}>{format(new Date(date), 'yyyy')}</time>
			{prismicHelpers.isFilled.group(media) && <p set:html={createMediaString()}></p>}
		</div>
	</header>

	<BlockList {body} />

	<!-- editions -->
	<section class="editions | border-seam-top">
		<Heading level={2}>{removeWidows('Available editions')}</Heading>
		<Gallery
			size="large"
			gutter="wide"
		>
			{editions.map((edition) => (
				<li>
					<Heading level={3}>{removeWidows(`${edition.name} print`)}</Heading>
					<Image source={edition.image} />
				</li>
			))}
		</Gallery>
	</section>
</Layout>

<style>
	header {
		margin-block-end: var(--space-wide);
	}

	.editions {
		padding: var(--space-wide) var(--space-outside);
		margin-block-start: var(--space-wide);
	}
</style>
