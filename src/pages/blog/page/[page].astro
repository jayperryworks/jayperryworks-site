---
// helpers
import prismic from '@lib/prismic.ts';
import prismicHelpers from '@prismicio/helpers';
import { format } from 'date-fns';

// components
import Layout from '@layouts/BaseLayout.astro';
import BlockList from '@components/BlockList.astro';

export async function getStaticPaths({ paginate }) {
	const posts = await prismic.getAllByType('blog_post', {
		orderings: {
			field: 'my.blog_post.date',
			direction: 'desc',
		},
	});

	return paginate(posts, { pageSize: 10 });
}

const {
	page
} = Astro.props;

const { next, prev } = page.url;

const postSummaryList = page.data.map(({ uid, tags, data }) => {
	// find the slices in each post marked as "include in excerpt"
	const summary = data.body.filter(({ primary }) => primary.include_in_excerpt);

	if (summary.length > 0) {
		return {
			...data,
			uid,
			tags,
			summary,
			path: `/blog/${format(new Date(data.date), 'yyyy')}/${format(new Date(data.date), 'MM')}/${format(new Date(data.date), 'dd')}/${uid}`,
		};
	}

	throw new Error(`Post missing a summary: ${prismicHelpers.asText(data.title)}, ${data.date}`);
});
---

<Layout
	path="blog"
	pageTitle="Blog"
>
	<ul class="post-list">
		{postSummaryList.map((post) => (
			<li>
				<article>
					<h2><a href={post.path}>{prismicHelpers.asText(post.title)}</a></h2>
					<time datetime={}>{format(new Date(post.date), 'MMMM dd, yyyy')}</time>
				</article>
			</li>
		))}
	</ul>

	<nav class="border-seam-top">
		{prev && <a href={prev}>Previous</a>}
		{next && <a href={next}>Next</a>}
	</nav>
</Layout>


<style>
	.post-list {
		list-style: none;
		display: block;
		padding-inline-start: 0;
	}
</style>
