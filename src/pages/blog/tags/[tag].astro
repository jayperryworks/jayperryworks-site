---
// styles
import '@styles/tokens/contentWidth.css';

// utils
import { format } from 'date-fns';
import * as prismicHelpers from '@prismicio/helpers';
import prismic from '@lib/prismic';
import { blog as permalink } from '@lib/permalinks';
import { sentenceCase } from '@lib/stringHelpers';

// components
import Layout from '@layouts/BaseLayout.astro';

// types
// import { Params } from 'astro';

export interface Post {
	title: string;
	subtitle?: string;
	path: string;
	date: string;
}

export interface Props {
	posts: Array<Post>;
}

export async function getStaticPaths() {
	// get all the blog posts from Prismic
	const allPosts = await prismic.getAllByType('blog_post', {
		orderings: {
			field: 'my.blog_post.date',
			direction: 'desc',
		},
	});

	// create a list of unique tags used in the blog posts
	const tags = allPosts.reduce((result, post) => {
		post?.tags.forEach((tag) => {
			if (!result.includes(tag)) result.push(tag);
		})
		return result;
	}, []);

	return tags.reduce((result, tag) => {
		// create an array of post objects for each tag
		const posts = allPosts
			.filter(({ tags }) => tags.includes(tag))
			.map((post) => {
				const { title, subtitle, date } = post.data;

				// clean up post data to just what we need for the listings
				return {
					title: prismicHelpers.asText(title),
					subtitle: prismicHelpers.asText(subtitle),
					path: permalink(post),
					date,
				};
			});

		if (posts) {
			result.push({
				params: {
					tag,
				},
				props: {
					posts,
				},
			});
		}

		return result;
	}, []);
}

const {
	tag,
} = Astro.params;

const {
	posts,
} = Astro.props as Props;
---

<Layout
	pageTitle={sentenceCase(tag)}
	path="blog"
>
	<div class="wrapper">
		<header>
			<p class="type-role-accent type-scale-gamma">Posts filed under</p>
			<h1>{sentenceCase(tag)}</h1>
		</header>
		<ul class="post-list">
			{posts.map((post) => (
				<li class="post">
					<article>
						<time
							class="type-role-accent type-scale-zeta"
							datetime={post.date}
						>
							{format(new Date(post.date), 'MMMM dd, yyyy')}
						</time>
						<h2 class="type-role-display type-scale-gamma">
							<a class="type-link-undecorated" href={post.path}>{post.title}</a>
						</h2>
						{post.subtitle && (
							<p class="type-role-accent type-scale-delta">
								<a class="type-link-undecorated" href={post.path}>{post.subtitle}</a>
							</p>
						)}
					</article>
				</li>
			))}
		</ul>
	</div>
</Layout>

<style>
	.wrapper {
		padding: var(--space-outside) var(--space-xwide);
	}

	header,
	.post-list {
		max-width: var(--content-width-default);
		margin-inline: auto;
	}

	header {
		padding-block-end: var(--space-medium);
	}

	.post-list {
		list-style: none;
	}

	.post {
		display: block;
		margin-inline: auto;
		max-width: var(--content-width-default);
	}

	.post + .post {
		padding-block-start: var(--space-medium);
	}
</style>
